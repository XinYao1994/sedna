apiVersion: sedna.io/v1alpha1
kind: FederatedLearningJob
metadata:
  name: surface-defect-detection
spec:
  stopCondition:
    operator: "or" # and
      conditions:
        - operator: ">"
          threshold: 100
          metric: GLOBAL_rounds
        - operator: ">"
          threshold: 0.95
          metric: GLOBAL_target_accuracy
        - operator: "<"
          threshold: 0.03
          metric: GLOBAL_delta_loss
  transimitter:
    transimitterAlgorithms:
      - name: "simple" # simple, adaptive_freezing, adaptive_sync ...
  aggregationTrigger:
    condition:
      operator: ">"
      threshold: 5
      metric: GLOBAL_num_of_select_clients
  aggregationWorker:
    model:
      name: "surface-defect-detection-model"
    template:
      spec:
        nodeName: "cloud"
        containers:
          - image: kubeedge/sedna-example-federated-learning-surface-defect-detection-aggregation:v0.1.0
            name: agg-worker
            imagePullPolicy: IfNotPresent
            env: # user defined environments
              - name: "GLOBAL_cut_layer"
                value: "4"
              - name: "GLOBAL_epsilon"
                value: "100"
              - name: "GLOBAL_aggregation_algorithm"
                value: "mistnet"
              - name: "GLOBAL_batch_size"
            resources: # user defined resources
              limits:
                memory: 2Gi
  trainingWorkers:
    - dataset:
        name: "edge1-surface-defect-detection-dataset"
      template:
        spec:
          nodeName: "edge1"
          containers:
            - image: kubeedge/sedna-example-federated-learning-surface-defect-detection-train:v0.1.0
              name: train-worker
              imagePullPolicy: IfNotPresent
              env: # user defined environments
                - name: "GLOBAL_batch_size"
                  value: "32"
                - name: "GLOBAL_learning_rate"
                  value: "0.001"
                - name: "GLOBAL_epochs"
                  value: "1"
              resources: # user defined resources
                limits:
                  memory: 2Gi
    - dataset:
        name: "edge2-surface-defect-detection-dataset"
      template:
        spec:
          nodeName: "edge2"
          containers:
            - image: kubeedge/sedna-example-federated-learning-surface-defect-detection-train:v0.1.0
              name: train-worker
              imagePullPolicy: IfNotPresent
              env: # user defined environments
                - name: "GLOBAL_batch_size"
                  value: "32"
                - name: "GLOBAL_learning_rate"
                  value: "0.001"
                - name: "GLOBAL_epochs"
                  value: "1"
              resources: # user defined resources
                limits:
                  memory: 2Gi
